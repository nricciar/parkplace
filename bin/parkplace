#!/usr/bin/env ruby
$:.unshift "./lib"
require 'optparse'
$PARKPLACE_ACCESSORIES = true
require 'rubygems'
gem 'mongrel'
gem 'activesupport', '~> 2.3.0'
gem 'activerecord',  '~> 2.3.0'

require 'parkplace'

DEFAULT_PASSWORD = 'pass@word1'
DEFAULT_SECRET = 'OtxrzxIsfpFjA7SwPzILwy8Bw21TLhquhboDYROV'

#

options = ParkPlace.options
options.host = "127.0.0.1"
options.port = 3002

opts = OptionParser.new do |opts|
    opts.banner = "Usage: parkplace [options] [host] [port]"
    opts.separator "Default host is #{options.host}, default port is #{options.port}."

    opts.separator ""
    opts.separator "Specific options:"

    opts.on("-d", "--directory DIRECTORY",
            "Park Place directory (defaults to #{options.parkplace_dir || 'None'})") do |d|
        options.parkplace_dir = d
    end

    opts.on("-D", "--daemon",  "Daemon mode (run in background)") do |d|
        options.daemon = true
    end

    opts.on("-r", "--replicate HOSTNAME", "Mirror master server") do |s|
        options.replication = { }
        options.replication[:enabled] = true unless s.nil?
        options.replication[:host] = s
    end

    opts.on("--replicate-secret KEY", "secret key for replication") do |s|
        options.replication ||= { }
        options.replication[:secret_access_key] ||= s
    end

    opts.on("--replicate-user USERNAME", "for authentication (defaults to 'admin')") do |k|
        options.replication ||= { }
        options.replication[:username] ||= k
    end

    opts.on("-v", "--verbose", "Run verbosely") do |v|
        options.verbose = v
    end

    opts.on("-u", "--debug", "Debug Mode") do |v|
        begin
          require 'ruby-debug'
          Debugger.start
        rescue LoadError
        end
        $DEBUG = v
    end

    opts.on("-s", "--strict", "S3 API ONLY (No added ParkPlace features)") do |v|
        $PARKPLACE_ACCESSORIES = false
    end

    opts.separator ""
    opts.separator "Common options:"

    opts.on_tail("-h", "--help", "Show this message") do
      puts opts
      exit
    end

    # Another typical switch to print the version.
    opts.on_tail("--version", "Show version") do
      puts ParkPlace::VERSION
      exit
    end
end

opts.parse! ARGV
options.host = ARGV[0] if ARGV[0]
options.port = ARGV[1].to_i if ARGV[1]
ParkPlace.config(options)

include ParkPlace

ParkPlace::Models::Base.establish_connection(options.database)
ParkPlace::Models::Base.logger = Logger.new('camping.log') if $DEBUG
ParkPlace.create

num_users = ParkPlace::Models::User.count
if num_users == 0
    puts "** No users found, creating the `admin' user."
    ParkPlace::Models::User.create :login => "admin", :password => DEFAULT_PASSWORD,
        :email => "admin@parkplace.net", :key => "44CF9590006BF252F707", :secret => DEFAULT_SECRET,
        :activated_at => Time.now, :superuser => 1
end

admin = ParkPlace::Models::User.find_by_login "admin"
if num_users == 1 and admin and admin.password == hmac_sha1( DEFAULT_PASSWORD, admin.secret )
    puts "** Please login in with `admin' and password `#{DEFAULT_PASSWORD}'"
    puts "** You should change the default password for the admin at soonest chance!"
end

ParkPlace.serve(options.host, options.port)
